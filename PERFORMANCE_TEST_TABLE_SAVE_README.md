# 性能测试表格保存功能

## 功能概述

性能测试模块现在支持将测试结果保存为CSV表格格式，方便后续分析和分享。

## 主要特性

### 1. 保存按钮
- 在性能测试界面添加了"保存为表格"按钮
- 测试完成后按钮自动启用
- 测试进行中按钮自动禁用

### 2. CSV格式输出
保存的CSV文件包含以下部分：

#### 测试概览
```
=== 性能测试结果概览 ===
测试时间,HH:mm:ss
测试名称,测试耗时(ms),测试状态,测试摘要
```

#### 内存测试详细数据
```
=== 内存测试详细数据 ===
时间戳,内存使用(MB),总内存(MB),内存使用率(%),堆大小(MB),空闲堆(MB)
```

#### 内存统计
```
内存统计,平均值(MB),最大值(MB),最小值(MB),基线(MB),峰值(MB)
```

#### 延迟测试详细数据
```
=== 延迟测试详细数据 ===
时间戳,消息ID,开始时间,结束时间,延迟(ms),状态
```

#### 延迟统计
```
延迟统计,平均值(ms),最大值(ms),最小值(ms),消息数量
```

#### CPU测试详细数据
```
=== CPU测试详细数据 ===
时间戳,CPU使用率(%),线程数,运行时间(ms)
```

#### CPU统计
```
CPU统计,平均使用率(%),最大使用率(%),最大线程数,样本数量
```

## 使用方法

### 1. 运行测试
1. 打开应用，点击"性能测试"按钮
2. 在性能测试界面点击"开始测试"
3. 等待测试完成

### 2. 保存结果
1. 测试完成后，"保存为表格"按钮变为可用状态
2. 点击"保存为表格"按钮
3. 系统会自动生成CSV文件并保存到应用的外部文件目录
4. 弹出分享对话框，可以选择分享到其他应用

### 3. 文件位置
- 文件保存在：`/storage/emulated/0/Android/data/com.have_no_eyes_deer.bleawsgateway/files/`
- 文件名格式：`performance_test_yyyyMMdd_HHmmss.csv`

## 技术实现

### 1. 文件保存
- 使用`FileWriter`写入CSV格式
- 文件保存在应用的外部文件目录，确保安全性
- 文件名包含时间戳，避免覆盖

### 2. 文件分享
- 使用`FileProvider`安全地分享文件
- 支持分享到邮件、云存储、即时通讯等应用
- 添加了错误处理机制

### 3. 权限配置
在`AndroidManifest.xml`中添加了：
- `WRITE_EXTERNAL_STORAGE`权限
- `FileProvider`配置
- `file_paths.xml`路径配置

## 代码结构

### 主要修改的文件：

1. **PerformanceTestActivity.java**
   - 添加了`btnSaveResults`按钮
   - 实现了`saveResultsToTable()`方法
   - 实现了`shareFile()`方法
   - 添加了按钮状态管理

2. **PerformanceTestManager.java**
   - 添加了`allTestResults`列表存储所有测试结果
   - 添加了`getAllTestResults()`方法
   - 修改了`generateTestReport()`方法保存结果
   - 修改了`resetTestData()`方法清空结果

3. **activity_performance_test.xml**
   - 添加了保存按钮的UI布局

4. **AndroidManifest.xml**
   - 添加了文件写入权限
   - 添加了FileProvider配置

5. **file_paths.xml**
   - 定义了文件提供者的路径配置

## 数据格式说明

### CSV文件结构
- 使用UTF-8编码
- 字段用逗号分隔
- 字符串字段不包含引号（除非包含逗号）
- 数值字段直接输出，不格式化

### 时间戳格式
- 使用毫秒级时间戳
- 可以通过Excel等工具转换为可读时间

### 统计计算
- 平均值：使用算术平均值
- 最大值/最小值：使用Java Stream API
- 样本数量：使用List.size()

## 使用示例

### 在Excel中打开
1. 保存CSV文件后，用Excel打开
2. 选择"数据" -> "从文本/CSV"
3. 选择保存的CSV文件
4. 设置分隔符为逗号
5. 导入数据后可以进行图表分析

### 数据分析
- 内存使用趋势：可以绘制内存使用量随时间的变化图
- 延迟分布：可以分析延迟的分布情况
- CPU使用率：可以监控CPU使用率的波动

## 注意事项

1. **权限要求**：首次使用可能需要授予存储权限
2. **文件大小**：长时间测试可能产生较大的CSV文件
3. **兼容性**：CSV格式兼容大多数数据分析工具
4. **安全性**：文件保存在应用私有目录，相对安全

## 故障排除

### 常见问题：

1. **保存失败**
   - 检查存储权限是否已授予
   - 检查设备存储空间是否充足

2. **分享失败**
   - 检查是否有可用的分享应用
   - 检查FileProvider配置是否正确

3. **文件格式错误**
   - 确保使用支持UTF-8的编辑器打开
   - 检查CSV分隔符设置

## 扩展功能

### 可能的改进：
1. 支持导出为Excel格式（.xlsx）
2. 添加图表生成功能
3. 支持自定义导出字段
4. 添加数据压缩功能
5. 支持云端同步保存 